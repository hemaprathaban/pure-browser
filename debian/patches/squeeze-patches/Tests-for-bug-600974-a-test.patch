From: Simon Montagu <smontagu@smontagu.org>
Date: Wed, 20 Oct 2010 09:11:15 -0700
Subject: Tests for bug 600974, a=test

---
 intl/uconv/tests/unit/test_bug317216.js |   79 +++++++++++++++++---------
 layout/reftests/bugs/600974-1-ref.html  |    2 +-
 layout/reftests/bugs/600974-1.html      |    2 +-
 layout/reftests/bugs/600974-2.html      |   94 +++++++++++++++++++++++++++++++
 layout/reftests/bugs/600974-3.html      |  Bin 0 -> 11314 bytes
 layout/reftests/bugs/reftest.list       |    2 +
 6 files changed, 150 insertions(+), 29 deletions(-)
 create mode 100644 layout/reftests/bugs/600974-2.html
 create mode 100644 layout/reftests/bugs/600974-3.html

diff --git a/intl/uconv/tests/unit/test_bug317216.js b/intl/uconv/tests/unit/test_bug317216.js
index bf57419..746c63e 100644
--- a/intl/uconv/tests/unit/test_bug317216.js
+++ b/intl/uconv/tests/unit/test_bug317216.js
@@ -11,53 +11,53 @@
 
 const test = [
 // 0: Valid surrogate pair
-              ["%00%2D%00%2D%D8%35%DC%20%00%2D%00%2D",
+              ["%D8%35%DC%20%00%2D%00%2D",
 //    expected: surrogate pair
-               "--\uD835\uDC20--"],
+               "\uD835\uDC20--"],
 // 1: Lone high surrogate
-              ["%00%2D%00%2D%D8%35%00%2D%00%2D",
+              ["%D8%35%00%2D%00%2D",
 //    expected: one replacement char
-               "--\uFFFD--"],
+               "\uFFFD--"],
 // 2: Lone low surrogate
-              ["%00%2D%00%2D%DC%20%00%2D%00%2D",
+              ["%DC%20%00%2D%00%2D",
 //    expected: one replacement char
-               "--\uFFFD--"],
+               "\uFFFD--"],
 // 3: Two high surrogates
-              ["%00%2D%00%2D%D8%35%D8%35%00%2D%00%2D",
+              ["%D8%35%D8%35%00%2D%00%2D",
 //    expected: two replacement chars
-               "--\uFFFD\uFFFD--"],
+               "\uFFFD\uFFFD--"],
 // 4: Two low surrogates
-              ["%00%2D%00%2D%DC%20%DC%20%00%2D%00%2D",
+              ["%DC%20%DC%20%00%2D%00%2D",
 //    expected: two replacement chars
-              "--\uFFFD\uFFFD--"],
+	       "\uFFFD\uFFFD--"],
 // 5: Low surrogate followed by high surrogate
-              ["%00%2D%00%2D%DC%20%D8%35%00%2D%00%2D",
+              ["%DC%20%D8%35%00%2D%00%2D",
 //    expected: two replacement chars
-               "--\uFFFD\uFFFD--"],
+               "\uFFFD\uFFFD--"],
 // 6: Lone high surrogate followed by valid surrogate pair
-              ["%00%2D%00%2D%D8%35%D8%35%DC%20%00%2D%00%2D",
+              ["%D8%35%D8%35%DC%20%00%2D%00%2D",
 //    expected: replacement char followed by surrogate pair
-               "--\uFFFD\uD835\uDC20--"],
+               "\uFFFD\uD835\uDC20--"],
 // 7: Lone low surrogate followed by valid surrogate pair
-              ["%00%2D%00%2D%DC%20%D8%35%DC%20%00%2D%00%2D",
+              ["%DC%20%D8%35%DC%20%00%2D%00%2D",
 //    expected: replacement char followed by surrogate pair
-               "--\uFFFD\uD835\uDC20--"],
+               "\uFFFD\uD835\uDC20--"],
 // 8: Valid surrogate pair followed by lone high surrogate
-              ["%00%2D%00%2D%D8%35%DC%20%D8%35%00%2D%00%2D",
+              ["%D8%35%DC%20%D8%35%00%2D%00%2D",
 //    expected: surrogate pair followed by replacement char
-               "--\uD835\uDC20\uFFFD--"],
+               "\uD835\uDC20\uFFFD--"],
 // 9: Valid surrogate pair followed by lone low surrogate
-              ["%00%2D%00%2D%D8%35%DC%20%DC%20%00%2D%00%2D",
+              ["%D8%35%DC%20%DC%20%00%2D%00%2D",
 //    expected: surrogate pair followed by replacement char
-               "--\uD835\uDC20\uFFFD--"],
+               "\uD835\uDC20\uFFFD--"],
 // 10: Lone high surrogate at the end of the input
-              ["%00%2D%00%2D%00%2D%00%2D%D8%35%",
+              ["%D8%35%",
 //    expected: nothing
-               "----"],
+               ""],
 // 11: Half code unit at the end of the input
-              ["%00%2D%00%2D%00%2D%00%2D%D8",
+              ["%D8",
 //    expected: nothing
-              "----"]];
+              ""]];
 
 const IOService = Components.Constructor("@mozilla.org/network/io-service;1",
                                          "nsIIOService");
@@ -95,15 +95,40 @@ function testCase(testText, expectedText, bufferLength, charset)
   do_check_eq(escape(outStr), escape(expectedText));
 }
 
+// Add 32 dummy characters to the test text to work around the minimum buffer
+// size of an ns*Buffer
+const MINIMUM_BUFFER_SIZE=32;
+function padBytes(str)
+{
+  var padding = "";
+  for (var i = 0; i < MINIMUM_BUFFER_SIZE; ++i) {
+    padding += "%00%2D";
+  }
+  return padding + str;
+}
+
+function padUnichars(str)
+{
+  var padding = "";
+  for (var i = 0; i < MINIMUM_BUFFER_SIZE; ++i) {
+    padding += "-";
+  }
+  return padding + str;
+}
+
 // Byte-swap %-encoded utf-16
 function flip(str) { return str.replace(/(%..)(%..)/g, "$2$1"); }
 
 function run_test()
 {
   for (var i = 0; i < 12; ++i) {
-    for (var bufferLength = 4; bufferLength < 8; ++ bufferLength) {
-      testCase(test[i][0], test[i][1], bufferLength, "UTF-16BE");
-      testCase(flip(test[i][0]), test[i][1], bufferLength, "UTF-16LE");
+    for (var bufferLength = MINIMUM_BUFFER_SIZE;
+	 bufferLength < MINIMUM_BUFFER_SIZE + 4;
+	 ++ bufferLength) {
+      var testText = padBytes(test[i][0]);
+      var expectedText = padUnichars(test[i][1]);
+      testCase(testText, expectedText, bufferLength, "UTF-16BE");
+      testCase(flip(testText), expectedText, bufferLength, "UTF-16LE");
     }
   }
 }
diff --git a/layout/reftests/bugs/600974-1-ref.html b/layout/reftests/bugs/600974-1-ref.html
index 9bf883b..71b6ce9 100644
--- a/layout/reftests/bugs/600974-1-ref.html
+++ b/layout/reftests/bugs/600974-1-ref.html
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML>
-<html>
+<html lang="en" style="font-family: serif; font-size: 16px">
 <head>
   <meta http-equiv="Content-Type"
  content="text/html; charset=ISO-8859-1">
diff --git a/layout/reftests/bugs/600974-1.html b/layout/reftests/bugs/600974-1.html
index 13de69f..9cbfee1 100644
--- a/layout/reftests/bugs/600974-1.html
+++ b/layout/reftests/bugs/600974-1.html
@@ -1,7 +1,7 @@
 <!DOCTYPE html>
 <!-- This is a test for decoding supplementary characters. It contains text in
      Unicode plane 1 encoded as UTF-8. Don't reencode it in any way. -->
-<html>
+<html lang="en" style="font-family: serif; font-size: 16px">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 </head>
diff --git a/layout/reftests/bugs/600974-2.html b/layout/reftests/bugs/600974-2.html
new file mode 100644
index 0000000..5c14bde
--- /dev/null
+++ b/layout/reftests/bugs/600974-2.html
@@ -0,0 +1,94 @@
+<!DOCTYPE HTML>
+<!-- This is a test for decoding supplementary characters. It contains text in
+     Unicode plane 1 encoded as GB18030. Don't reencode it in any way. -->
+<html lang="en" style="font-family: serif; font-size: 16px">
+<head>
+  <meta http-equiv="Content-Type" content="text/html; charset=gb18030">
+  <title></title>
+</head>
+<body>
+<p>3736393634 3037303234 3536333639 303031 32343631,
+3436353036343136313239 32353037303034303538 36333031. 36333038323234
+333633 32393432 35303339, 333633 353034313234 313639313639. 38393230
+30323432333030 36333031 36383631 35323534 303633333034303132353035 3631
+34363434363536 3336333031 32333038323234. 32323030383236 333633
+3330333635353234 343232393030. 393233333234 353634 3736333030 35303234,
+333633 333233373231323136 3732393230. 38393230 3739323936313932,
+3336333031 3330313236 3732333330353239 343239303230, 35303033
+3732393230 373639313130313639 38323234, 353635 32353037303034303538
+36393630 343232393030 3632 3736333030. 393233333234 333234313230
+35303030 303031 32343631 35303033 30363532333630 3035313639353234.
+313633333635313630383236 333233373231323136 32333038323234 333636, 3035
+39393635343230 303634 34363434363536 3035. 343635 33323639363631
+3035313639353234 3436353530343635313234. 393233333234 363935323936
+33363031303332333234 3736393132. 363635363235 3035 3536333639
+3536333639, 353634 3633363037363535 3536383236. 3936353634
+313035343035323531 34363434363536 35303033, 353635
+3034363336393030383236 3536333639 3234343234303235 3035.
+3139323630363531 3330333635353234 33303336393932 3032303430373031.
+39323534 3436353530343635313234, 32353136 3330313236
+3436353530343635313234 39393635343230, 35323534 35303339
+3732333330353239 313239373030, 3035 3336333639313030 3332343230 333636
+3231 3930303230. 343635 3035 36353034 313639313639, 3330313236
+3234343234303235 3930303230. 36333038323234 3430 36393231,
+34363434363536 353634 3336333639313030 353635, 353038353030303034
+36383631 36393630. 3132303436 3332343230 3432303032,
+3436353036343136313239 3330313236 3739323936313932 303635,
+33303336393932 3035 38323234.
+383239323330313239 353634 32393432 38323234, 303031 32343631
+313035343035323531 3332343230. 343635 3436333630313036
+353038353030303034 35303033, 3231 373639343635313234 343232393030
+36383630313230 353634. 343635 3430 38323234, 323331393034303630 3231
+313035343035323531 333633, 3330333635353234 3234 3432303032.
+37363031303332333234 333633 3930303230 3736393132 343232393030
+313634373639 33333235353031 3632 333633 35303234. 32323030383236
+36393630 333033363936, 313634373639 3231 36383630313230 353634,
+32333038323631 36383631 36333031. 3936353634 33333235353031 36353036
+3231 35303339 333239303230 313930303130383236. 343635 39393635343230
+3736393132 36393430, 3733323436393231 3436353530343635313234 36393430
+303437363935303631 3330313236. 3031303234 3632 3739323936313932
+36393630. 3435 333635363532313030 373633333635313630383236 333033363936
+303635 36383630313230. 39323030 313035343035323531 3436333630313036
+3930303230 3035 393231393234. 3932333332 3732343033303030. 39323030
+333633 3732393230 3234 333033363936 393231393234 3233313930343630
+303635 333633 3232383236. 3936353634 36383631 35303234 3631
+333033363936 373633333635313630383236 333635363532313030 353635 3631
+3732393230. 3631 3632 333634313230 3732393230, 36383631 38393233303532
+36393231. 343635 353634 3736333030 333038323332, 36383631 333234313230
+36393231. 383232393030 303237303635 363031, 343231313030 3231
+3732323430333230 3631, 3732323430333230 353634 35323534. 39323534
+313634373230 30323432333030 32393532 3330313236 353038353030303034.
+3435 35323534 35303030, 3233333234343639373639 333633 3739323936313932
+3336333231373231, 303437363935303631 32 35303234.
+313633333635313630383236 333633 333038323332 36383631 333636
+323234313639 39393635343230 343635333233333030 32 313639313639.
+3031303234 3231 333634313230 3330313236 32353136 313634373230
+323331393034303630 3231 3330313236 36333031. 393234 3035 313239373030
+3037303234, 3231 343231313030 313639313639. 3932333332 3631
+373633333635313630383236 3536383236. 3936353634 33323430353032,
+313239373030 3231 353034313234 30363532333630, 353230 35303030
+373234303330303030 3930303230, 303635 33333235353031 3430 36333031 3231
+35303339. 36333038323234 36393231 3336333231373231.
+313633333635313630383236 353634 36333031 3035 3132303136
+3035313639353234 363935323936 32 3035 35303234. 3836393330 3231
+373930353830333332 333634313230. 3936353634 343635333233333030
+3633363037363535 3736333030, 3035 3032383031313030 32393532
+343231313030 353634. 3631 343635303638323231 313239373030 333633
+38323234 313634373639 36383631 3233313930343630 3536383236
+3436333630313036. 3432303736353530303036 313633333230 35303030,
+393635353936393031 3330313236 37363032363936 36383631, 3733323436393231
+303635 3436313230. 34353136383639 3733323436393231 303437363935303631
+3733323436393231. 3836393330 313634373230 35323534 35323534.
+34353136383639 38323030 36393430 3736333030. 39323534 303634373639,
+32393432 353635 343635303638323231 353038353030303034, 3336393634
+32393532 3739323936313932 3430, 353634 3234343234303235 36353034 3430
+32 3732393230. 383239323330313239 3631 36333031 3035 303634
+30363532333630 3035313639353234. 313633333635313630383236
+3032383031313030 393231393234 333634313230 34363434363536
+3436353530343635313234. 3031303234 373930353830333332, 38323234 353634
+3233333234343639373639 303633333034303132353035, 313239373030 35303030
+32333038323631 3930303230, 303031 32343631 363336343635313234
+3536333639 3336393634 3330313236 333038323332. 3139323630363531
+3739323936313932 32333038323631 3336333031 303635 3733323436393231. </p>
+</body>
+</html>
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
index 87a8b4e..427a2d4 100644
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -1054,4 +1054,6 @@ fails == 494667-2.html 494667-2-ref.html # needs bug 155955 (not on 1.9.1 branch
 != 513318-2.xul 513318-2-ref.xul
 != 513318-3.xul 513318-3-ref.xul
 == 600974-1.html 600974-1-ref.html
+== 600974-2.html 600974-1-ref.html
+== 600974-3.html 600974-1-ref.html
 == 603423-1.html 603423-1-ref.html
