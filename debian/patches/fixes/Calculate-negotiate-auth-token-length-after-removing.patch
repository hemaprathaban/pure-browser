From: Mike Hommey <mh@glandium.org>
Date: Wed, 1 Sep 2010 18:03:10 +0200
Subject: Calculate negotiate auth token length after removing padding

https://bugzilla.mozilla.org/show_bug.cgi?id=592692
Closes: #590040
---
 extensions/auth/nsHttpNegotiateAuth.cpp |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/extensions/auth/nsHttpNegotiateAuth.cpp b/extensions/auth/nsHttpNegotiateAuth.cpp
index c81e69d..1e1d9c5 100644
--- a/extensions/auth/nsHttpNegotiateAuth.cpp
+++ b/extensions/auth/nsHttpNegotiateAuth.cpp
@@ -257,15 +257,15 @@ nsHttpNegotiateAuth::GenerateCredentials(nsIHttpChannel *httpChannel,
             challenge++;
         len = strlen(challenge);
 
+        // strip off any padding (see bug 230351)
+        while (challenge[len - 1] == '=')
+            len--;
+
         inTokenLen = (len * 3)/4;
         inToken = malloc(inTokenLen);
         if (!inToken)
             return (NS_ERROR_OUT_OF_MEMORY);
 
-        // strip off any padding (see bug 230351)
-        while (challenge[len - 1] == '=')
-            len--;
-
         //
         // Decode the response that followed the "Negotiate" token
         //
